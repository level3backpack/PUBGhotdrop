<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PUBG Hot Drop</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map { height: 100vh; }
        .marker-counter {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: white;
            padding: 10px;
            z-index: 1000;
            border-radius: 4px;
        }
        .clear-button {
            background-color: red;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="marker-counter">
        Drops: <span id="dropCounter">0</span>
        <button class="clear-button" id="clearButton">X</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <script>
        // Firebase configuration
        var firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);

        const db = firebase.firestore();
        let userId = null;
        let userMarker = null;

        // Set up the map centered on Erangel's custom coordinates
        const map = L.map('map').setView([0, 0], 3); // Adjust to Erangel bounds
        L.tileLayer('https://your-erangel-tile-layer-url/{z}/{x}/{y}.png', {
            attribution: 'Â© Your Map Source',
            maxZoom: 5,
            minZoom: 1,
            tileSize: 512,
            zoomOffset: -1
        }).addTo(map);

        // Handle anonymous sign-in and marker loading
        firebase.auth().signInAnonymously()
            .then((userCredential) => {
                userId = userCredential.user.uid;
                console.log("Signed in as anonymous user:", userId);

                loadUserMarker();
                loadAllMarkers();
                updateMarkerCounter();
            })
            .catch((error) => {
                console.error("Error during anonymous sign-in:", error);
            });

        // Load the user's marker from Firestore
        function loadUserMarker() {
            db.collection("markers").doc(userId).get().then((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    userMarker = L.marker([data.lat, data.lng], { draggable: true }).addTo(map);
                    map.setView([data.lat, data.lng], 5);
                    userMarker.on('dragend', function (e) {
                        saveMarker(userMarker.getLatLng());
                    });
                }
            }).catch((error) => {
                console.error("Error loading user marker:", error);
            });
        }

        // Load all markers from Firestore
        function loadAllMarkers() {
            db.collection("markers").get().then((querySnapshot) => {
                querySnapshot.forEach((doc) => {
                    if (doc.id !== userId) {
                        const data = doc.data();
                        L.marker([data.lat, data.lng]).addTo(map);
                    }
                });
            }).catch((error) => {
                console.error("Error loading all markers:", error);
            });
        }

        // Save the user's marker to Firestore
        function saveMarker(latlng) {
            db.collection("markers").doc(userId).set({
                lat: latlng.lat,
                lng: latlng.lng
            })
            .then(() => {
                console.log("Marker successfully saved!");
                updateMarkerCounter();
            })
            .catch((error) => {
                console.error("Error saving marker:", error);
            });
        }

        // Update the drop counter
        function updateMarkerCounter() {
            db.collection("markers").get().then((querySnapshot) => {
                const count = querySnapshot.size;
                document.getElementById('dropCounter').textContent = count;
            }).catch((error) => {
                console.error("Error updating marker counter:", error);
            });
        }

        // Add or move marker on map click
        map.on('click', function(e) {
            if (userMarker) {
                userMarker.setLatLng(e.latlng);
            } else {
                userMarker = L.marker(e.latlng, { draggable: true }).addTo(map);
                userMarker.on('dragend', function (e) {
                    saveMarker(userMarker.getLatLng());
                });
            }
            saveMarker(e.latlng);
        });

        // Clear user's marker when the X button is clicked
        document.getElementById('clearButton').addEventListener('click', function() {
            if (userMarker) {
                map.removeLayer(userMarker);
                db.collection("markers").doc(userId).delete().then(() => {
                    console.log("Marker successfully removed!");
                    updateMarkerCounter();
                }).catch((error) => {
                    console.error("Error removing marker:", error);
                });
            }
        });
    </script>
</body>
</html>
