<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PUBG Hot Drop</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map { height: 100vh; }
    </style>
</head>
<body>
    <div id="map"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <script>
        // Firebase configuration
        var firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);

        const db = firebase.firestore();

        let userId = null; // Placeholder for authenticated user's unique ID
        let userMarker = null; // Placeholder for the user's marker

        // Replace with your Erangel tile layer URL
        let map = L.map('map').setView([0, 0], 3); // Adjust to Erangel's actual bounds

        L.tileLayer('https://your-erangel-tile-layer-url/{z}/{x}/{y}.png', {
            attribution: 'Â© Your Map Source',
            maxZoom: 5, // Adjust based on your tile layer
            minZoom: 1, // Adjust based on your tile layer
            tileSize: 512, // Adjust based on tile size if required
            zoomOffset: -1 // Adjust based on tile zoom level if required
        }).addTo(map);

        // Anonymous sign-in
        firebase.auth().signInAnonymously()
            .then((userCredential) => {
                userId = userCredential.user.uid; // Get unique user ID
                console.log("Signed in as anonymous user:", userId);

                // Load the user's marker from Firestore and all other markers
                loadUserMarker();
                loadAllMarkers();
            })
            .catch((error) => {
                console.error("Error during anonymous sign-in:", error);
            });

        // Function to load the user's own marker from Firestore
        function loadUserMarker() {
            db.collection("markers").doc(userId).get().then((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    userMarker = L.marker([data.lat, data.lng], {draggable: true}).addTo(map);
                    map.setView([data.lat, data.lng], 5); // Adjust to Erangel zoom level
                    userMarker.on('dragend', function (e) {
                        saveMarker(userMarker.getLatLng());
                    });
                } else {
                    console.log("No marker found for this user.");
                }
            }).catch((error) => {
                console.error("Error loading user marker:", error);
            });
        }

        // Function to load all markers (excluding the user's own marker) from Firestore
        function loadAllMarkers() {
            db.collection("markers").get().then((querySnapshot) => {
                querySnapshot.forEach((doc) => {
                    if (doc.id !== userId) { // Exclude user's own marker
                        const data = doc.data();
                        L.marker([data.lat, data.lng]).addTo(map);
                    }
                });
            }).catch((error) => {
                console.error("Error loading all markers:", error);
            });
        }

        // Function to save or update the user's marker in Firestore
        function saveMarker(latlng) {
            db.collection("markers").doc(userId).set({
                lat: latlng.lat,
                lng: latlng.lng
            })
            .then(() => {
                console.log("Marker successfully saved!");
            })
            .catch((error) => {
                console.error("Error saving marker:", error);
            });
        }

        // Click event to add or move the user's marker
        map.on('click', function(e) {
            if (userMarker) {
                userMarker.setLatLng(e.latlng); // Move marker to new location
            } else {
                userMarker = L.marker(e.latlng, {draggable: true}).addTo(map); // Add new marker
                userMarker.on('dragend', function (e) {
                    saveMarker(userMarker.getLatLng());
                });
            }
            saveMarker(e.latlng); // Save the new marker location to Firestore
        });
    </script>
</body>
</html>
